filterOptions(field: Field) {
  const search = (field.searchText || '').toLowerCase();

  // Build filters from other fields
  const filters: Record<string, string[]> = {};
  this.fields.forEach(f => {
    if (f !== field && f.value.length > 0) {
      const jsonKey = this.fieldToJsonKey[f.name];
      if (jsonKey) {
        filters[jsonKey] = f.value;
      }
    }
  });

  // Filter entries by other fields
  const filteredEntries = this.entries.filter(e =>
    Object.keys(filters).every(jsonKey =>
      filters[jsonKey].some(val => e[jsonKey] === val)
    )
  );

  // --- Special case: Measure
  if (field.name.toLowerCase() === 'measure') {
    const allowedValues = ['Raw', 'Std'].filter(m => 
      (m === 'Raw' && filteredEntries.some(e => e.is_raw_available)) ||
      (m === 'Std' && filteredEntries.some(e => e.is_std_available))
    );
    return allowedValues.filter(opt => opt.toLowerCase().includes(search) && !field.value.includes(opt));
  }

  // Normal case for other fields
  const jsonKey = this.fieldToJsonKey[field.name];
  const allowedValues = [
    ...new Set(filteredEntries.map(e => e[jsonKey as string]))
  ];

  return allowedValues
    .filter(opt => opt && !field.value.includes(opt))
    .filter(opt => opt.toLowerCase().includes(search));
}


addField(selectedName: string) {
  const exists = this.fields.find(f => f.name === selectedName);
  if (exists) return;

  const jsonKey = this.fieldToJsonKey[selectedName];  // ✅ map properly
  this.fields.push({
    name: selectedName,
    value: [],
    unique: Math.floor(Math.random() * 200),
    constant: 151760,
    values: jsonKey ? this.getUniqueValues(jsonKey) : [], // ✅ load values
    checked: false,
    searchText: ''
  });

  setTimeout(() => {
    if (this.criteriaContainer) {
      this.criteriaContainer.nativeElement.scrollTop = this.criteriaContainer.nativeElement.scrollHeight;
    }
  });
}
fieldToJsonKey: Record<string, string | null> = {
  'Basket_Name': 'basket_name',
  'Factor_Description': 'factor_description',
  'Factor_name': 'factor_name',
  'Factor_group_name': 'factor_group_name',
  'Basket_Region': 'basket_region',
  'Measure': null // special case
};

